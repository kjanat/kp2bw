# Progress Log

PRD: performance-bw-serve-transport
Started: 2026-02-23

## Codebase Patterns

- **Module logger**: each module uses `logger = logging.getLogger(__name__)`
- **Custom exceptions only**: `BitwardenClientError` for bw failures, `ConversionError` for migration logic
- **`signal.getsignal` type**: returns `Callable[[int, FrameType | None], Any] | int | None`, not `signal.Handlers`. Use `isinstance(prev, int) or prev is None` to narrow before calling.
- **`from __future__ import annotations`**: use in new modules for PEP 604 union syntax in annotations
- **httpx added as runtime dep**: `httpx>=0.28.0` in pyproject.toml
- **4-phase import pattern**: partition → bulk import → sync+ID recovery → parallel attachments
- **`isinstance(att, Attachment)` for narrowing**: prefer checking against the known class rather than `tuple`

---

<!-- Task logs below - APPEND ONLY -->

## Task - serve-lifecycle

- Implemented `BitwardenServeClient` in `src/kp2bw/bw_serve.py` (240 lines)
- Process lifecycle: `_start_serve()` → `_wait_for_ready()` (poll GET /status) → `_unlock()` → `_sync()`
- Cleanup: `atexit.register`, SIGTERM/SIGINT handlers, context manager `__enter__`/`__exit__`
- Random port via `_find_free_port()` (bind to 0, read assigned port)
- Generic `_request()` helper: parses bw serve JSON envelope (`success`/`data`/`message`)
- Added `httpx>=0.28.0` to runtime dependencies
- Files changed: `src/kp2bw/bw_serve.py` (new), `pyproject.toml`, `uv.lock`
- **Learnings:** `ty` is strict about `signal.getsignal` return type — can't use `callable()` to narrow since `int` is callable; use `isinstance(prev, int)` guard instead

## Task - serve-crud

- Added CRUD methods to `BitwardenServeClient`: `list_folders`, `create_folder`, `has_folder`, `list_items`, `create_item`
- `list_folders()` returns `{name: id}` dict from `GET /list/object/folders`
- `create_folder(name)` returns cached ID or creates via `POST /object/folder`; auto-caches
- `list_items(folder_id=)` returns items from `GET /list/object/items` with optional folderid filter
- `create_item(item)` posts to `POST /object/item`, returns server-assigned ID
- `__init__` now loads folder cache after sync via `self._folders = self.list_folders()`
- Files changed: `src/kp2bw/bw_serve.py`
- **Learnings:** bw serve list endpoints nest data under `data.data` (outer `data` from envelope, inner `data` from list response)

## Task - dedup-via-serve

- Added `_build_dedup_index()` → `dict[str | None, set[str]]` mapping folder names to item name sets
- Added `entry_exists(folder, name)` for O(1) dedup checks
- Added `refresh_dedup_index()` to re-query after import
- `__init__` now builds dedup index after folder cache: `self._existing_entries = self._build_dedup_index()`
- Reversed folder id→name lookup for mapping item folderId back to folder names
- Files changed: `src/kp2bw/bw_serve.py`
- **Learnings:** old client used `list` for dedup (O(K) per check); new uses `set` (O(1))

## Task - import-batch

- Created `src/kp2bw/bw_import.py` with three functions:
  - `build_import_file(entries)` — collects unique folders, assigns synthetic UUIDs, builds `bitwardenjson` dict
  - `run_import(filepath)` — executes `bw import bitwardenjson <path>` subprocess
  - `write_and_import(entries)` — orchestrator: build → write temp file → import → delete temp
- Shallow-copies item dicts to avoid mutating caller state
- Strips transient `firstlevel` key from items (not part of import format)
- Files changed: `src/kp2bw/bw_import.py` (new)
- **Learnings:** ruff PERF102 catches dict `.items()` when only `.values()` needed; SIM115 requires context manager for `NamedTemporaryFile`

## Task - async-attachments

- Added three methods to `BitwardenServeClient`:
  - `upload_attachment(client, item_id, filename, data)` — async single multipart POST
  - `upload_attachments_parallel(items, max_concurrency=4)` — async bounded gather with `asyncio.Semaphore`
  - `upload_attachments(items, max_concurrency=4)` — sync wrapper via `asyncio.run()`
- `items` arg is `list[tuple[str, list[tuple[str, bytes]]]]` — item_id → list of (filename, data) pairs
- Uses separate `httpx.AsyncClient` for async operations (sync client can't do async)
- Files changed: `src/kp2bw/bw_serve.py`
- **Learnings:** none — clean implementation, all checks passed first try

## Task - collection-support

- Added `list_collections()` → `{name: id}` from `GET /list/object/org-collections`
- Added `create_org_collection(name)` → cached `POST /object/org-collection`
- `__init__` loads existing collections if `org_id` set
- Simplified vs old client: no template fetch needed — POST body includes `organizationId`, `name`, `groups`
- Files changed: `src/kp2bw/bw_serve.py`
- **Learnings:** bw serve collection creation doesn't need a template — just POST the full body directly

## Task - cli-integration

- Rewrote `_create_bitwarden_items_for_entries()` — 4-phase architecture:
  1. Partition entries: resolve collections, dedup, build import dict + attachment map
  2. Bulk import via `write_and_import()`
  3. Post-import sync + item ID recovery by `(folder_name, item_name)` matching
  4. Parallel attachment uploads via `bw.upload_attachments()`
- Added helper methods: `_unpack_entry()`, `_resolve_collection()`, `_materialise_attachment()`
- Replaced `BitwardenClient` import with `BitwardenServeClient` + `write_and_import`
- Added `folders` property to `BitwardenServeClient` for public access to folder cache
- Removed unused `json` import from convert.py
- `bitwardenclient.py` kept for now (will be deleted when all references confirmed removed)
- Files changed: `src/kp2bw/convert.py`, `src/kp2bw/bw_serve.py`
- **Learnings:** `isinstance(att, Attachment)` works better for type narrowing than `isinstance(att, tuple)` when Attachment is from stubs; ruff preview catches `noqa` for non-enabled rules
