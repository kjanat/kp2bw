# Progress Log

PRD: performance-bw-serve-transport
Started: 2026-02-23

## Codebase Patterns

- **Module logger**: each module uses `logger = logging.getLogger(__name__)`
- **Custom exceptions only**: `BitwardenClientError` for bw failures, `ConversionError` for migration logic
- **`signal.getsignal` type**: returns `Callable[[int, FrameType | None], Any] | int | None`, not `signal.Handlers`. Use `isinstance(prev, int) or prev is None` to narrow before calling.
- **`from __future__ import annotations`**: use in new modules for PEP 604 union syntax in annotations
- **httpx added as runtime dep**: `httpx>=0.28.0` in pyproject.toml

---

<!-- Task logs below - APPEND ONLY -->

## Task - serve-lifecycle

- Implemented `BitwardenServeClient` in `src/kp2bw/bw_serve.py` (240 lines)
- Process lifecycle: `_start_serve()` → `_wait_for_ready()` (poll GET /status) → `_unlock()` → `_sync()`
- Cleanup: `atexit.register`, SIGTERM/SIGINT handlers, context manager `__enter__`/`__exit__`
- Random port via `_find_free_port()` (bind to 0, read assigned port)
- Generic `_request()` helper: parses bw serve JSON envelope (`success`/`data`/`message`)
- Added `httpx>=0.28.0` to runtime dependencies
- Files changed: `src/kp2bw/bw_serve.py` (new), `pyproject.toml`, `uv.lock`
- **Learnings:** `ty` is strict about `signal.getsignal` return type — can't use `callable()` to narrow since `int` is callable; use `isinstance(prev, int)` guard instead

## Task - serve-crud

- Added CRUD methods to `BitwardenServeClient`: `list_folders`, `create_folder`, `has_folder`, `list_items`, `create_item`
- `list_folders()` returns `{name: id}` dict from `GET /list/object/folders`
- `create_folder(name)` returns cached ID or creates via `POST /object/folder`; auto-caches
- `list_items(folder_id=)` returns items from `GET /list/object/items` with optional folderid filter
- `create_item(item)` posts to `POST /object/item`, returns server-assigned ID
- `__init__` now loads folder cache after sync via `self._folders = self.list_folders()`
- Files changed: `src/kp2bw/bw_serve.py`
- **Learnings:** bw serve list endpoints nest data under `data.data` (outer `data` from envelope, inner `data` from list response)

## Task - dedup-via-serve

- Added `_build_dedup_index()` → `dict[str | None, set[str]]` mapping folder names to item name sets
- Added `entry_exists(folder, name)` for O(1) dedup checks
- Added `refresh_dedup_index()` to re-query after import
- `__init__` now builds dedup index after folder cache: `self._existing_entries = self._build_dedup_index()`
- Reversed folder id→name lookup for mapping item folderId back to folder names
- Files changed: `src/kp2bw/bw_serve.py`
- **Learnings:** old client used `list` for dedup (O(K) per check); new uses `set` (O(1))
