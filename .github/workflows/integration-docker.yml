# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: Integration (Docker)
on:
  workflow_call:
  pull_request:
  push: { branches: [master] }
  workflow_dispatch:
jobs:
  vaultwarden-e2e:
    runs-on: ubuntu-latest
    permissions: { contents: read }
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Run Vaultwarden end-to-end migration test
        run: |
          echo "::group::Build Docker images"
          docker compose -f tests/docker-compose.yml build
          echo "::endgroup::"
          docker compose -f tests/docker-compose.yml up \
            --abort-on-container-exit --exit-code-from test

      - name: Show Vaultwarden logs on failure
        if: failure() || cancelled()
        run: docker compose -f tests/docker-compose.yml logs vaultwarden

      - name: Cleanup
        if: always()
        run: docker compose -f tests/docker-compose.yml down --volumes
