services:
  vaultwarden:
    container_name: server
    build:
      context: .
      dockerfile: Dockerfile.vaultwarden
    environment:
      I_REALLY_WANT_VOLATILE_STORAGE: "true"
      SIGNUPS_ALLOWED: "false"
      DOMAIN: "https://vaultwarden"
      ROCKET_PORT: "443"
      ROCKET_TLS: '{certs="/ssl/cert.pem",key="/ssl/key.pem"}'
    healthcheck:
      test: ["CMD", "curl", "-fsk", "https://localhost/"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 5s
    networks: [testnet]

  test:
    container_name: kp2bw
    build:
      context: ..
      dockerfile: tests/Dockerfile.test
    depends_on:
      vaultwarden:
        condition: service_healthy
    environment:
      BW_SERVER_URL: "https://vaultwarden"
      BW_CERT_PATH: "/app/tests/fixtures/vaultwarden-certs/cert.pem"
      NODE_EXTRA_CA_CERTS: "/app/tests/fixtures/vaultwarden-certs/cert.pem"
      BW_TEST_EMAIL: "integration@example.com"
      BW_TEST_PASSWORD: "TestMasterPassword123!"
      KP_TEST_PASSWORD: "KpSnapshotPassword123!"
    networks: [testnet]

networks:
  testnet:
